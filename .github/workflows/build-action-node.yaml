name: Build & Release Node/TypeScript Action

on:
  workflow_call:
    inputs:
      node-version:
        required: true
        type: string
        description: Node.js version to use
      package-manager:
        required: false
        type: string
        default: 'npm'
        description: Package manager to use (npm, yarn, or pnpm)
      build-script:
        required: false
        type: string
        default: 'build'
        description: npm script name for building
      test-script:
        required: false
        type: string
        default: 'test'
        description: npm script name for testing
      lint-script:
        required: false
        type: string
        default: 'lint'
        description: npm script name for linting (optional - skipped if not present)
      require-release-flag:
        required: false
        type: boolean
        default: false
        description: Only create a release if the commit contains [release]
      minor-pattern:
        required: false
        type: string
        default: '/^(feat|feature)/'
        description: Pattern for minor version bump
      major-pattern:
        required: false
        type: string
        default: '/(\!: |BREAKING CHANGE)/'
        description: Pattern for major version bump
      notes-start-tag:
        required: false
        type: string
        description: The tag to use as the start point for generating release notes
    outputs:
      published:
        description: true if a release was created
        value: ${{ jobs.release.outputs.published || 'false' }}
      new-version:
        description: The new version that was released
        value: ${{ jobs.release.outputs.new-version || '' }}

env:
  TZ: 'Europe/Oslo'

jobs:
  validate:
    name: Validate Inputs
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Validate inputs
        env:
          PACKAGE_MANAGER: ${{ inputs.package-manager }}
          BUILD_SCRIPT: ${{ inputs.build-script }}
          TEST_SCRIPT: ${{ inputs.test-script }}
          LINT_SCRIPT: ${{ inputs.lint-script }}
        run: |
          # Validate package manager
          ALLOWED_MANAGERS=("npm" "yarn" "pnpm")
          
          if [[ ! " ${ALLOWED_MANAGERS[@]} " =~ " ${PACKAGE_MANAGER} " ]]; then
            echo "::error::Invalid package-manager: '${PACKAGE_MANAGER}'. Allowed values: npm, yarn, pnpm"
            exit 1
          fi
          echo "âœ“ Package manager '${PACKAGE_MANAGER}' is valid"
          
          # Validate script names (only alphanumeric, dash, underscore, colon allowed)
          SCRIPT_NAME_PATTERN='^[a-zA-Z0-9:_-]+$'
          
          for script_name in "$BUILD_SCRIPT" "$TEST_SCRIPT" "$LINT_SCRIPT"; do
            if [[ -n "$script_name" && ! "$script_name" =~ $SCRIPT_NAME_PATTERN ]]; then
              echo "::error::Invalid script name: '${script_name}'. Only alphanumeric, dash, underscore, and colon allowed"
              exit 1
            fi
          done
          echo "âœ“ Script names are valid"
          
          # Validate that package.json exists
          if [[ ! -f "package.json" ]]; then
            echo "::error::package.json not found in repository root"
            exit 1
          fi
          echo "âœ“ package.json exists"
          
          # Validate that required scripts are defined in package.json
          VALIDATION_FAILED=false
          
          if [[ -n "$BUILD_SCRIPT" ]] && ! grep -q "\"$BUILD_SCRIPT\"" package.json; then
            echo "::error::Required build script '$BUILD_SCRIPT' not found in package.json"
            VALIDATION_FAILED=true
          fi
          
          if [[ -n "$TEST_SCRIPT" ]] && ! grep -q "\"$TEST_SCRIPT\"" package.json; then
            echo "::error::Required test script '$TEST_SCRIPT' not found in package.json"
            VALIDATION_FAILED=true
          fi
          
          if [[ -n "$LINT_SCRIPT" ]] && ! grep -q "\"$LINT_SCRIPT\"" package.json; then
            echo "::error::Required lint script '$LINT_SCRIPT' not found in package.json"
            VALIDATION_FAILED=true
          fi
          
          if [[ "$VALIDATION_FAILED" == "true" ]]; then
            echo ""
            echo "Available scripts in package.json:"
            grep -A 20 '"scripts"' package.json | grep -E '^\s*"[^"]+":' || echo "  (none found)"
            exit 1
          fi
          
          echo "âœ“ All required scripts are defined in package.json"

  prepare:
    name: Determine Release
    needs: validate
    runs-on: ubuntu-latest
    permissions: {}
    outputs:
      releasing: ${{ steps.check-release.outputs.releasing }}
    steps:
      - name: Determine if releasing
        id: check-release
        env:
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          if [[ '${{ github.ref_name }}' != 'main' ]]; then
            echo "Not on main branch, skipping release"
            echo "releasing=false" >> $GITHUB_OUTPUT
          
          elif [[ '${{ github.actor }}' == *'[bot]'* ]] || [[ '${{ github.triggering_actor }}' == *'[bot]'* ]]; then
            echo "Pushed by bot, skipping release"
            echo "releasing=false" >> $GITHUB_OUTPUT
          
          elif [[ "$COMMIT_MESSAGE" =~ \[skip\ release\]|\[release\ skip\]|\[skip\ publish\]|\[publish\ skip\] ]]; then
            echo "Commit message contains skip marker, skipping release"
            echo "releasing=false" >> $GITHUB_OUTPUT
        
          elif [[ "${{ inputs.require-release-flag }}" == "true" ]]; then
            if [[ "$COMMIT_MESSAGE" =~ \[release\] ]]; then
              echo "Release commit detected ([release] flag required and present)"
              echo "releasing=true" >> $GITHUB_OUTPUT
            else
              echo "[release] flag required but not present, skipping release"
              echo "releasing=false" >> $GITHUB_OUTPUT
            fi
          
          else
            echo "Releasing from main without [release] flag (not required)"
            echo "releasing=true" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build, Test and Validate
    needs: [validate, prepare]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: ${{ inputs.node-version }}
          cache: ${{ inputs.package-manager }}

      - name: Install dependencies
        env:
          PACKAGE_MANAGER: ${{ inputs.package-manager }}
        run: |
          if [[ "$PACKAGE_MANAGER" == "npm" ]]; then
            npm ci
          elif [[ "$PACKAGE_MANAGER" == "yarn" ]]; then
            yarn install --frozen-lockfile
          elif [[ "$PACKAGE_MANAGER" == "pnpm" ]]; then
            pnpm install --frozen-lockfile
          fi

      - name: Lint
        if: inputs.lint-script != ''
        env:
          PACKAGE_MANAGER: ${{ inputs.package-manager }}
          LINT_SCRIPT: ${{ inputs.lint-script }}
        run: $PACKAGE_MANAGER run $LINT_SCRIPT

      - name: Build
        if: inputs.build-script != ''
        env:
          PACKAGE_MANAGER: ${{ inputs.package-manager }}
          BUILD_SCRIPT: ${{ inputs.build-script }}
        run: $PACKAGE_MANAGER run $BUILD_SCRIPT

      - name: Validate built files are in sync
        run: |
          # Check if there are any uncommitted changes after build
          if [[ -n $(git status --porcelain) ]]; then
            echo "::error::Built files are not in sync with source code!"
            echo "The following files have changes:"
            git status --porcelain
            echo ""
            echo "Please rebuild locally and commit the changes:"
            echo "  npm run build"
            echo "  git add ."
            echo "  git commit -m 'chore: rebuild action'"
            exit 1
          else
            echo "âœ“ Built files are in sync with source code"
          fi

      - name: Test
        if: inputs.test-script != ''
        env:
          PACKAGE_MANAGER: ${{ inputs.package-manager }}
          TEST_SCRIPT: ${{ inputs.test-script }}
        run: $PACKAGE_MANAGER run $TEST_SCRIPT

  release:
    name: Release Action
    needs: [prepare, build]
    if: ${{ needs.prepare.outputs.releasing == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new-version: ${{ steps.calculate-version.outputs.version }}
      published: ${{ steps.publish.outputs.published }}
    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0

      - name: Calculate new tag for versioning
        id: calculate-version
        uses: paulhatch/semantic-version@a8f8f59fd7f0625188492e945240f12d7ad2dca3 #v5.4.0
        with:
          tag_prefix: "v"
          search_commit_body: true
          version_format: 'v${major}.${minor}.${patch}'
          major_pattern: ${{ inputs.major-pattern }}
          minor_pattern: ${{ inputs.minor-pattern }}

      - name: Set start tag for generating notes
        id: set-start-tag
        env:
          GH_TOKEN: ${{ github.token }}
          NOTES_START_TAG: ${{ inputs.notes-start-tag }}
          REPOSITORY: ${{ github.repository }}
        shell: bash
        run: |
          if [[ -z "$NOTES_START_TAG" ]]; then
            set +e # Fail silently if no releases are found
            LATEST_TAG_OR_ERROR=$(gh api repos/$REPOSITORY/releases/latest --jq .tag_name 2>/dev/null)
            EXIT_CODE=$?
            set -e # Re-enable error checking
            
            if [[ $EXIT_CODE -eq 0 ]]; then
              LATEST_TAG="$LATEST_TAG_OR_ERROR"
            else
              LATEST_TAG="none"
            fi
            echo "notes-start-tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          else
            echo "notes-start-tag=$NOTES_START_TAG" >> $GITHUB_OUTPUT
          fi

      - name: Create Github Release with generated notes
        id: publish
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ steps.calculate-version.outputs.version }}
          NOTES_START_TAG: ${{ steps.set-start-tag.outputs.notes-start-tag }}
        shell: bash
        run: |
          # Check if release already exists
          if gh release view "$VERSION" >/dev/null 2>&1; then
            echo "::warning::Release $VERSION already exists, skipping creation"
            echo "published=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Create release
          if [[ $NOTES_START_TAG == "none" ]]; then
            gh release create "$VERSION" --generate-notes
          else
            gh release create "$VERSION" --generate-notes --notes-start-tag $NOTES_START_TAG
          fi
          
          echo "published=true" >> $GITHUB_OUTPUT
          echo "âœ“ Release $VERSION created successfully"

      - name: Update major and minor version tags
        if: steps.calculate-version.outputs.version_type != 'none'
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ steps.calculate-version.outputs.version }}
          MAJOR: ${{ steps.calculate-version.outputs.major }}
          MINOR: ${{ steps.calculate-version.outputs.minor }}
          VERSION_TYPE: ${{ steps.calculate-version.outputs.version_type }}
        shell: bash
        run: |
          echo "ðŸ“¦ Version bump type: $VERSION_TYPE"
          echo "ðŸ“Œ Creating/updating version tags for $VERSION"
          echo ""
          TAG_PREFIX: ${{ inputs.tag-prefix }}
          # Get the SHA for the version tag
          VERSION_SHA=$(gh api repos/${{ github.repository }}/git/ref/tags/$VERSION --jq .object.sha)
          
          # Update major tag (v1)
          echo "ðŸ”„ Updating major tag v$MAJOR â†’ $VERSION"
          if gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/v$MAJOR" >/dev/null 2>&1; then
            echo "   Deleted existing tag v$MAJOR"
          else
            echo "   No existing tag v$MAJOR found (first release)"
          fi
          
          gh api -X POST "repos/${{ github.repository }}/git/refs" \
            -f ref="refs/tags/v$MAJOR" \
            -f sha="$VERSION_SHA" >/dev/null
          echo "   âœ“ Created tag v$MAJOR"
          
          # Update minor tag (v1.2)
          echo ""
          echo "ðŸ”„ Updating minor tag v$MAJOR.$MINOR â†’ $VERSION"
          if gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/v$MAJOR.$MINOR" >/dev/null 2>&1; then
            echo "   Deleted existing tag v$MAJOR.$MINOR"
          else
            echo "   No existing tag v$MAJOR.$MINOR found (first release)"
          fi
          
          gh api -X POST "repos/${{ github.repository }}/git/refs" \
            -f ref="refs/tags/v$MAJOR.$MINOR" \
            -f sha="$VERSION_SHA" >/dev/null
          echo "   âœ“ Created tag v$MAJOR.$MINOR"
          
          echo ""
          echo "âœ… Version tags updated successfully!"
          echo "   â€¢ v$VERSION (exact version)"
          echo "   â€¢ v$MAJOR (latest major)"
          echo "   â€¢ v$MAJOR.$MINOR (latest minor)"

  summary:
    name: Workflow Summary
    needs: [validate, prepare, build, release]
    if: always()
    runs-on: ubuntu-latest
    permissions: {}
    steps:
      - name: Generate workflow summary
        env:
          VALIDATE_RESULT: ${{ needs.validate.result }}
          PREPARE_RESULT: ${{ needs.prepare.result }}
          BUILD_RESULT: ${{ needs.build.result }}
          RELEASE_RESULT: ${{ needs.release.result }}
          RELEASING: ${{ needs.prepare.outputs.releasing }}
          PUBLISHED: ${{ needs.release.outputs.published }}
          NEW_VERSION: ${{ needs.release.outputs.new-version }}
          REF_NAME: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          PACKAGE_MANAGER: ${{ inputs.package-manager }}
          NODE_VERSION: ${{ inputs.node-version }}
        run: |
          echo "# Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [[ "$BUILD_RESULT" == "success" ]]; then
            echo "## âœ… Build Status: Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Build Status: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Job results table
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Validate
          if [[ "$VALIDATE_RESULT" == "success" ]]; then
            echo "| Validate Inputs | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Validate Inputs | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Build
          if [[ "$BUILD_RESULT" == "success" ]]; then
            echo "| Build & Test | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          elif [[ "$BUILD_RESULT" == "skipped" ]]; then
            echo "| Build & Test | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Build & Test | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Release
          if [[ "$RELEASE_RESULT" == "success" ]]; then
            echo "| Release | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          elif [[ "$RELEASE_RESULT" == "skipped" ]]; then
            echo "| Release | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Release | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Release information
          echo "### Release Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "$RELEASING" == "true" && "$PUBLISHED" == "true" ]]; then
            echo "ðŸŽ‰ **Released version \`$NEW_VERSION\`**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Version: \`$NEW_VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "- Major tag: \`v${NEW_VERSION%%.*}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Minor tag: \`v${NEW_VERSION%.*}\`" >> $GITHUB_STEP_SUMMARY
            echo "- [View Release](https://github.com/${{ github.repository }}/releases/tag/$NEW_VERSION)" >> $GITHUB_STEP_SUMMARY
          elif [[ "$RELEASING" == "true" && "$PUBLISHED" == "false" ]]; then
            echo "âš ï¸ **Release skipped** (version already exists)" >> $GITHUB_STEP_SUMMARY
          elif [[ "$RELEASING" == "false" ]]; then
            echo "â„¹ï¸ **No release created**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [[ "$REF_NAME" != "main" ]]; then
              echo "- Reason: Not on main branch (\`$REF_NAME\`)" >> $GITHUB_STEP_SUMMARY
            elif [[ "$ACTOR" == *"[bot]"* ]]; then
              echo "- Reason: Triggered by bot (\`$ACTOR\`)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- Reason: Commit message contains skip marker or [release] flag not present" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Build configuration
          echo "### Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Node.js: \`$NODE_VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- Package Manager: \`$PACKAGE_MANAGER\`" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`$REF_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: \`$ACTOR\`" >> $GITHUB_STEP_SUMMARY
